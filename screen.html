<!DOCTYPE html>
<html>
	<head>
		<title>Tjube.Ninja Screen</title>
		<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta charset="utf-8">
		<meta name="description" content="Tjube.Ninja screen, play videos added with the remote.">
		<meta name="author" content="tjallingt">

		<!-- CSS -->
		<link rel="stylesheet" href="/perfect-scrollbar/perfect-scrollbar.min.css">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
		<style>
			* {
				margin: 0px;
				padding: 0px;
				-webkit-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
			body {
				background-color: #000;
				color: #FFF;
				font-family: Futura, “Trebuchet MS”, Arial, sans-serif;
				overflow: hidden;
				font-size: 115%;
			}
			
			#title, #subtitle {
				text-shadow: 0px 0px 10px black, 0px 0px 10px black;
				position: absolute;
				top: 10px;
				left: 10px;
				font-size: 150%;
				white-space: nowrap;
			}
			#subtitle {
				text-shadow: 0px 0px 10px black, 0px 0px 10px black;
				top: 45px;
				left: 45px;
				font-size: 100%;
				color: lightgrey;
				cursor: pointer;
			}
			#subtitle.playnext::before {
				content: "\f051";
				font: normal normal normal 14px/1 FontAwesome;
				font-size: inherit;
				text-rendering: auto;
				-webkit-font-smoothing: antialiased;
				margin-right: 10px;
			}
			#subtitle:hover {
				color: white;
			}
			
			#playlistWrapper {
				position: absolute;
				right: 0px;
				top: 0px;
				width: 7%;
				min-width: 90px;
				height: 100%;
				opacity: 0.5;
				
				transition: width 250ms ease, opacity 250ms ease;
			}
			#playlistWrapper:hover {
				width: 25%;
				opacity: 1;
			}
			#playlist, #searchResults {
				position: absolute;
				right: 0px;
				list-style-type: none;
				width: 100%;
				height: calc(100% - 35px);
				text-shadow: 0px 0px 20px black, 0px 0px 20px black, 0px 0px 20px black;
				cursor: default;
				overflow-x: hidden;
				overflow-y: auto;
			}
			#playlist>li, #searchResults>li {
				background-color: #000;
				height: 50px;
				line-height: 50px; 
				vertical-align: middle;
				padding-right: 10px;
			}
			
			#playlist>li {
				background-repeat: no-repeat;
				background-position: center;
				background-size: cover;
			}
			#playlist>li>.controls {
				display: none;
				font-size: 110%;
				text-shadow: 0px 0px 30px black, 0px 0px 30px black, 0px 0px 30px black, 0px 0px 30px black;
			}
			#playlist>li>.controls.remove{
				position: absolute;
				right: 20px;
			}
			#playlist>li:hover .controls {
				display: inline;
			}
			#playlist>li>.icon {
				position: absolute;
				margin-left: 5px;
				line-height: 50px;
			}
			#playlist>li>.title {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				display: inline-block;
				width: calc(100% - 20px);
				padding-left: 20px;
				opacity: 0;
			}
			#playlistWrapper:hover #playlist>li>.title {
				opacity: 1;
			}
			
			#searchBarWrapper {
				height: 0px;
				transition: height 250ms ease;
			}
			#playlistWrapper:hover #searchBarWrapper {
				height: 35px;
			}
			#searchBar {
				float: left;
				width: 90%;
				border: none;
				height: 100%;
				padding-left: 5px;
			}

			#searchCancel {
				height: 100%;
				line-height: 35px;
				float: right;
				background-color: #FFF;
				width: 10%;
				margin-left: -5px;
				color: black;
				vertical-align: middle;
				text-align: center;
			}
			#searchResults {
				display: none;
				background-color: black;
				z-index: 1;
			}
			.searchCancelHover:hover {
				background-color: #EEE !important;
				cursor: pointer;
			}
			#searchResults>li {
				border-bottom: 1px solid white;
				text-shadow: none;
			}
			#searchResults>li:hover {
				background-color: #222;
				cursor: pointer;
			}
			#searchResults>li>.title {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				line-height: 25px;
			}
			#searchResults>li>.contentData {
				font-size: 75%;
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
				line-height: 25px;
			}
			#searchResults>li>img {
				height: 100%;
				float: left;
				margin-right: 5px;
			}
			
			#progressBarWrapper {
				position: fixed;
				bottom: 0px;
				width: 100%;
				height: 20px;
				z-index: 2;
			}
			#progressBar {
				background-color: red;
				width: 0px;
				height: 15%;
				position: absolute;
				bottom: 0px;
				
				transition: height 0.1s linear;
			}
			#progressBar::after {
				content: "";
				width: 0px;
				height: 100%;
				background-color: #FFF;
				float:right;
				
				transition: width 0.1s linear;
			}
			#progressBarWrapper:hover #progressBar {
				height: 100%;
			}
			#progressBarWrapper:hover #progressBar::after {
				width: 5px;
			}
			
			#aboutWrapper {
				position: absolute;
				bottom: 10px;
				left: 10px;
				opacity: 0.5;
				
				transition: bottom 0.1s linear;
			}
			#aboutWrapper:hover {
				opacity: 1;
			}
			#progressBarWrapper:hover + #aboutWrapper {
				bottom: 20px;
			}
			#about {
				color: white;
				text-decoration: none;
				text-shadow: 0px 0px 10px black, 0px 0px 10px black;
			}
			#about .fa {
				margin: 0 5px;
				padding-right: 1px;
			}
		</style>
	</head>
	<body>
		
		<div id="title"></div>
		<div id="subtitle"></div>
		
		<div id="player"></div>
		
		<div id="playlistWrapper">
			<div id="searchBarWrapper">
				<input type="text" id="searchBar"  placeholder="Search for videos" autocomplete="off">
				<div id="searchCancel"></div>
			</div>
			<ul id="searchResults"></ul>
			<ul id="playlist"></ul>
		</div>
		
		<div id="progressBarWrapper">
			<div id="progressBar"></div>
		</div>
		
		<div id="aboutWrapper">
			<a id="about" href="/about" target="_blank">
				<i class="fa fa-question-circle fa-lg"></i>
				<span id="room"></span>
			</a>
		</div>
		
		
		<!-- JS -->
		<script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
		<script src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
		<script src="/perfect-scrollbar/perfect-scrollbar.jquery.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script src="https://www.youtube.com/iframe_api"></script>
		<script>			
			// YouTube API code
			var apiKey = "AIzaSyCIPY7lwNyrTFIQmvMPsFHWh54IA2gMvHY";
			var apiUrl = "https://www.googleapis.com/youtube/v3";
			var youtube = {};
			var quality = "default";
			var playing = false;
			var socket = io.connect( window.location.origin );
			var delaySearchCancel = (function(){
				var timer = 0;
				return function(){
					clearTimeout( timer );
					timer = setTimeout( searchCancel, 25000 );
				};
			})();
			var delaySearch = (function(){
				var timer = 0;
				return function( callback ){
					clearTimeout( timer );
					timer = setTimeout( callback, 400 );
				};
			})();
			
			function onYouTubeIframeAPIReady() {
				youtube = new YT.Player( "player" , {
					height: $( window ).height(),
					width: $( window ).width(),
					playerVars: {
						controls: 0,
						cc_load_policy : 0,
						iv_load_policy: 3,
						modestbranding: 1,
						rel: 0,
						showinfo: 0,
						fs: 0
					},
					events: {
						"onReady": onPlayerReady,
						"onStateChange": onPlayerStateChange,
						"onError": onPlayerError
					}
				});
			}
			
			function onPlayerReady( event ) {
				youtube.unMute().setVolume( 100 );
				getPlaylistStore();
				showTitle();
				$( "#room" ).text( "/add/" + location.pathname.split("/")[2] );
				$( "#playlist" ).perfectScrollbar();
				$( "#searchResults" ).perfectScrollbar();
			}
			
			function onPlayerStateChange( event ) {
				if ( event.data == YT.PlayerState.ENDED ) playNextVideo();
				if ( event.data == YT.PlayerState.PLAYING) {
					showProgressBar();
					showTitle( youtube.getVideoData().title );
				}
			}
			
			function onPlayerError( event ) {
				playNextVideo( "slow" );
			}
			
			function cueVideo( id ) {
				$.getJSON( apiUrl+"/videos?part=snippet&key="+apiKey+"&id="+id , function( data ) {
					if( data.items.length > 0 ) {
						var title = data.items[0].snippet.title, 
						image = data.items[0].snippet.thumbnails.default.url;
						if( data.items[0].snippet.thumbnails.hasOwnProperty("standard") ) image = data.items[0].snippet.thumbnails.standard.url;
						$( "#playlist" ).append( "<li id='"+ id +"' style=\"background-image: url("+ image +")\"><p class='fa fa-sort icon controls'></p><p class='title'>"+ title +"</p><p class='icon controls remove fa fa-times'></p></li>" );
						if( !playing ) playNextVideo();
						else {
							showSubTitle( $( "#playlist>li" ).first().children( ".title" ).text() );
							setPlaylistStore();
						}
					}
				});
			}

			function playNextVideo( duration ) {
				duration = ( duration == "" ) ? "fast" : duration; 
				if( $( "#playlist>li" ).length != 0 ) {
					playing = true;
					$( "#playlist>li" ).first().slideUp( duration, function() { 
						youtube.loadVideoById( $( this ).attr( "id" ) , 0, quality );
						$( this ).remove();
						$( "#playlist" ).perfectScrollbar( "update" );
						setPlaylistStore();
					});
				}
				else {
					youtube.stopVideo();
					youtube.clearVideo();
					showTitle();
					playing = false;
				}
			}
			
			$( "#playlist" ).on( "click", ".remove", function() {
				$( this ).parent().slideUp( "fast", function() { 
					$( this ).remove(); 
					showSubTitle( $( "#playlist>li" ).first().children( ".title" ).text() );
					setPlaylistStore();
				});
			});
			
			$( "#searchBar" ).on( "focus", function() {
				delaySearchCancel();
				$( "#playlistWrapper" ).css({width: "25%", opacity: "1"});
				$( "#searchBarWrapper" ).css({height: "35px"});
				$( "#searchCancel" ).text("X").addClass("searchCancelHover");
				$( "#searchResults" ).show();
			});
			
			$( "#searchBar" ).on( "keyup", function() {
				delaySearchCancel();
				
				delaySearch( function(){
					$( "#searchResults" ).empty();
					if( $( "#searchBar" ).val() == "" ) return;
					$.getJSON( apiUrl+"/search?videoEmbeddable=true&part=snippet&type=video&maxResults=20&key="+apiKey+"&q=" + $( "#searchBar" ).val() , function( queryData ) {
						var url = apiUrl+"/videos?part=contentDetails&key="+apiKey+"&id=";
						queryData.items.forEach( function( item ) {
							url += item.id.videoId + "%2C";
							$( "#searchResults" ).append( "<li id='"+ item.id.videoId +"'><img src="+ item.snippet.thumbnails.default.url +"><p class='title'>"+ item.snippet.title +"</p><p class='contentData'> by "+ item.snippet.channelTitle +"</p></li>" );
						});
						$.getJSON( url, function( contentData ) {
							contentData.items.forEach( function( item ) {
								$( "#searchResults>#"+item.id+">.contentData" ).prepend( item.contentDetails.duration.replace("PT","").toLowerCase() +" @ "+ item.contentDetails.definition );
							});
						});
						$( "#searchResults" ).perfectScrollbar( "update" );
					});
				});
			});
			
			$( "#searchResults" ).on( "click", "li", function() {
				delaySearchCancel();
				cueVideo( $( this ).attr( "id" ) );
				$( this ).slideUp( "fast", function() {
					$( "#searchResults" ).perfectScrollbar( "update" );
				});
			});
			
			$( "#searchCancel" ).on( "click", searchCancel );
			
			function searchCancel() {
				$( "#searchBar" ).val( "" ).blur();
				$( "#playlistWrapper" ).css({width: "", opacity: ""});
				$( "#searchBarWrapper" ).css({height: ""});
				$( "#searchCancel" ).text("").removeClass("searchCancelHover");
				$( "#playlist" ).perfectScrollbar( "update" );
				$( "#searchResults" ).fadeOut( "fast", function() {
					$( this ).hide().empty();
				});
			}
			
			function showProgressBar( time ) {
				time = ( typeof time === "undefined" ) ? youtube.getCurrentTime() : time;
				$( "#progressBar" ).width( time / youtube.getDuration() * 100 + "%" );
				if( youtube.getPlayerState() == YT.PlayerState.PLAYING ) setTimeout( showProgressBar, 250 ); 
			}
			$( "#progressBarWrapper" ).on( "click", function( e ) {
				var posX = e.pageX - $( this ).offset().left,
					percentage = posX / $( this ).width(),
					time = youtube.getDuration() * percentage;
					youtube.seekTo( time, true);
					showProgressBar( time );
			});
	
			function showTitle( title ) {
				title = ( !title ) ? "Add a video to the playlist to begin watching!" : title;
				if( $( "#title" ).text() != title) {
					$( "#title" ).fadeOut( "fast", function() {
						$( this ).text( title ).fadeIn( "slow" );
					});
				}
				showSubTitle( $( "#playlist>li" ).first().children( ".title" ).text() );
			}
			function showSubTitle( subtitle ) {
				var newSubtitle = ( !subtitle ) ? "To add videos from another device go to "+ location.host +"/add/"+ location.pathname.split("/")[2] : subtitle;
				if( $( "#subtitle" ).text() != newSubtitle) {
					$( "#subtitle" ).fadeOut( "fast", function() {
						if ( subtitle ) $( this ).addClass( "playnext" );
						else $( this ).removeClass( "playnext" );
						$( this ).text( newSubtitle ).fadeIn( "slow" );
					});
				}
			}
			$( "#subtitle" ).on( "click", function() {
				playNextVideo();
			});
			
			$( window ).resize(function() {
				$( "#player" ).height( $( window ).height() );
				$( "#player" ).width( $( window ).width() );
			});
			
			$( "#playlist" ).sortable({
				start: function( event, ui ) {
					$( "#playlistWrapper" ).css({width: "25%", opacity: "1"});
				},
				update: function( event, ui ) {
					showSubTitle( $( "#playlist>li" ).first().children( ".title" ).text() );
					setPlaylistStore();
					$( "#playlistWrapper" ).css({width: "", opacity: ""});
				},	
				axis: "y"
			});
			
			function setPlaylistStore() {
				if( typeof( Storage ) !== "undefined" ) {
					var playlist = [];
					$( "#playlist>li" ).each( function(){
						playlist.push( $( this ).attr( "id" ) );
					});
					sessionStorage[ location.pathname.split("/")[2] ] = JSON.stringify( playlist );
				}
			}
			function getPlaylistStore() {
				if( typeof( Storage ) !== "undefined" ) {
					var playlist = sessionStorage[ location.pathname.split("/")[2] ];
					if( playlist ) {
						playlist = JSON.parse( playlist );
						playlist.forEach( function( item ) {
							cueVideo( item );
						});
					}
				}
			}
			
			socket.on( "cueVideo", cueVideo );
		</script>
	</body>
</html>